<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>N-Back Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --accent-color: #0a84ff;
            --success-color: #30d158;
            --error-color: #ff453a;
            --input-bg: #2c2c2e;
            --border-color: #333;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Nunito', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #app-viewport {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            /* Убрали нижний паддинг вообще */
            padding-top: max(10px, env(safe-area-inset-top));
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 0; 
            transition: height 0.1s;
        }

        /* --- МЕНЮ --- */
        #setup-screen {
            flex: 1;
            width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        #setup-screen::-webkit-scrollbar { display: none; }

        .menu-content {
            width: 100%; 
            max-width: 400px; 
            margin: 0 auto;
            padding-bottom: 20px;
        }

        /* Распорка для клавиатуры в меню */
        #keyboard-spacer {
            height: 0px;
            width: 100%;
            flex-shrink: 0;
            transition: height 0.3s;
        }

        h1 { margin: 10px 0 25px 0; color: var(--accent-color); font-size: 2.4rem; font-weight: 800; text-align: center; }

        .settings-block {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }

        .block-title {
            color: var(--text-main);
            font-size: 1rem; font-weight: 800; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; text-align: center;
        }

        .mode-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 5px;
        }
        
        .mode-btn {
            background: var(--input-bg); border: 2px solid transparent; color: var(--text-muted);
            padding: 12px 5px; border-radius: 14px; font-size: 0.8rem; font-weight: 700;
            font-family: 'Nunito', sans-serif; cursor: pointer; transition: all 0.2s;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .mode-btn.active { background: rgba(10, 132, 255, 0.15); border-color: var(--accent-color); color: white; }
        .mode-btn.math-btn.active { background: rgba(48, 209, 88, 0.15); border-color: var(--success-color); }
        .mode-btn.super-btn { grid-column: span 1; background: linear-gradient(45deg, #2c2c2e, #3a3a3c); width: 100%; }
        .mode-btn.super-btn.active { background: linear-gradient(45deg, rgba(10, 132, 255, 0.2), rgba(48, 209, 88, 0.2)); border-color: #ffffff; }

        .setup-row { display: flex; gap: 10px; margin-top: 5px; }
        .input-group { flex: 1; display: flex; flex-direction: column; align-items: center; }
        label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 700; }
        
        input[type="number"] {
            background: var(--input-bg); border: none; color: white;
            padding: 12px; border-radius: 14px; font-size: 1.2rem;
            width: 100%; text-align: center; font-family: 'Nunito', sans-serif; font-weight: 700;
        }

        button.main-btn {
            background-color: var(--accent-color); color: white; font-weight: 800;
            border: none; padding: 18px; font-size: 1.3rem; border-radius: 18px;
            width: 100%; cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3);
        }
        button.main-btn:active { opacity: 0.8; transform: scale(0.98); }

        /* --- ИГРА --- */
        #game-screen {
            flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%;
        }

        .header {
            display: grid; grid-template-columns: 44px 1fr 44px; align-items: center;
            flex: 0 0 auto; margin: 10px 0;
        }

        .control-btn {
            background: #2c2c2e; border: none; color: var(--text-muted);
            width: 44px; height: 44px; border-radius: 50%; font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-family: 'Nunito', sans-serif;
        }

        .info-center { display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.3; }
        #timer, .stats-line { font-size: 0.95rem; font-weight: 700; color: var(--text-muted); font-variant-numeric: tabular-nums; }
        #timer { margin-bottom: 2px; }

        .game-area {
            flex: 1 1 auto; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; min-height: 0;
        }

        #word-card {
            background: var(--card-bg); border-radius: 24px; width: 100%; max-width: 400px;
            height: 60%; max-height: 220px; min-height: 160px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin-bottom: 20px; position: relative;
        }

        #word-index {
            position: absolute; top: 15px; width: 100%; text-align: center;
            font-size: 1rem; font-weight: 800; color: var(--text-muted); opacity: 0.5;
            line-height: 1;
        }

        #card-timer {
            position: absolute; bottom: 10px; width: 100%; text-align: center;
            color: var(--text-muted); opacity: 0.5;
            font-size: 1rem; font-weight: 800; font-variant-numeric: tabular-nums; line-height: 1;
        }

        #word-display {
            font-size: 2.5rem; font-weight: 800; color: #fff;
            text-transform: uppercase; margin: 0; text-align: center;
            word-break: break-word; hyphens: auto; line-height: 1;
        }
        .countdown-big { font-size: 5rem !important; color: var(--text-muted) !important; opacity: 0.5; }

        #countdown-dots {
            position: absolute; bottom: 10px; width: 100%; text-align: center;
            color: var(--text-muted); font-size: 1.8rem; font-weight: 700;
            letter-spacing: 12px; line-height: 1; height: 30px;
        }

        /* --- ВВОД --- */
        .input-wrapper {
            flex: 0 0 auto; width: 100%; max-width: 400px; margin: 0 auto; 
            /* Нижний отступ 2px - жестко */
            padding-bottom: 2px;
        }

        /* ТОЧКИ (ЖИЗНИ) */
        #attempts-bar { 
            text-align: center; 
            margin-bottom: 20px; 
            font-size: 2rem; 
            line-height: 1;
            height: 20px; 
            color: var(--text-muted); opacity: 0.5; 
            letter-spacing: 10px;
            transition: padding-right 0.2s; /* Плавный сдвиг при появлении кнопки */
        }
        /* Класс для сдвига точек влево, когда появляется кнопка справа */
        #attempts-bar.shifted {
            padding-right: 70px; /* 60px кнопка + 10px зазор */
        }

        #game-form { width: 100%; display: flex; gap: 8px; }

        #native-input {
            flex: 1;
            padding: 14px; font-size: 1.5rem; 
            background-color: var(--input-bg); border: 3px solid #3a3a3c; border-radius: 18px;
            color: white; text-align: center; box-sizing: border-box; outline: none;
            -webkit-appearance: none; font-family: 'Nunito', sans-serif; font-weight: 800;
        }
        #native-input:focus { border-color: var(--accent-color); background-color: #303033; }
        
        #submit-btn {
            width: 60px; background-color: var(--accent-color); border: none; border-radius: 18px;
            display: none; align-items: center; justify-content: center;
            cursor: pointer; color: white; font-size: 1.5rem; flex-shrink: 0;
        }
        #submit-btn:active { opacity: 0.8; transform: scale(0.95); }

        .input-error { border-color: var(--error-color) !important; animation: shake 0.4s; }
        .input-success { border-color: var(--success-color) !important; color: var(--success-color) !important; }

        .hidden { display: none !important; }

        #pause-overlay, #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        #result-screen { background: var(--bg-color); z-index: 60; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
    </style>
</head>
<body>

    <div id="app-viewport">
        
        <div id="setup-screen">
            <div class="menu-content">
                <h1>N-Back</h1>
                
                <div class="settings-block">
                    <div class="block-title">ЯЗЫК</div>
                    <div class="mode-grid">
                        <button class="mode-btn active" onclick="setMode('noun', this)">Существительные</button>
                        <button class="mode-btn" onclick="setMode('verb', this)">Глаголы</button>
                        <button class="mode-btn" onclick="setMode('adj', this)">Прилагательные</button>
                        <button class="mode-btn" onclick="setMode('mix', this)">Микс</button>
                    </div>
                </div>

                <div class="settings-block">
                    <div class="block-title">МАТЕМАТИКА</div>
                    <div class="mode-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <button class="mode-btn math-btn" onclick="setMode('math_table', this)">Таблица умн.</button>
                        <button class="mode-btn math-btn" onclick="setMode('math100', this)">1-100</button>
                        <button class="mode-btn math-btn" onclick="setMode('math500', this)">100-500</button>
                    </div>
                    
                    <div class="mode-grid" style="grid-template-columns: 1fr; margin-top: 10px;">
                        <button class="mode-btn super-btn" onclick="setMode('super_mix', this)">ЯЗЫК + МАТЕМАТИКА</button>
                    </div>
                </div>

                <div class="setup-row">
                    <div class="input-group">
                        <label>Уровень N</label>
                        <input type="number" id="n-level" value="2" min="1" max="10" 
                               onfocus="onInputFocus(this)" onblur="onInputBlur()">
                    </div>
                    <div class="input-group">
                        <label>Ответов</label>
                        <input type="number" id="round-count" value="20" min="5" max="200" 
                               onfocus="onInputFocus(this)" onblur="onInputBlur()">
                    </div>
                    <div class="input-group">
                        <label>Время (сек)</label>
                        <input type="number" id="memo-time" value="3" min="1" max="10" 
                               onfocus="onInputFocus(this)" onblur="onInputBlur()">
                    </div>
                </div>
                
                <button class="main-btn" onclick="startGame()">НАЧАТЬ</button>
            </div>
            <div id="keyboard-spacer"></div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="header">
                <button class="control-btn" onclick="stopGame()">✕</button>
                <div class="info-center">
                    <div id="timer">00:00</div>
                    <div class="stats-line">
                        <span id="display-n">2</span>-Back • <span id="progress">0/25</span>
                    </div>
                </div>
                <button class="control-btn" onclick="togglePause()">II</button>
            </div>

            <div class="game-area">
                <div id="word-card" class="hidden">
                    <div id="word-index" class="hidden">1</div>
                    <div id="word-display">...</div>
                    <div id="card-timer" class="hidden">3</div>
                </div>
                <div id="wait-msg" style="color: #777; font-size: 1.2rem; font-weight: 700;" class="hidden">Запоминаем...</div>
            </div>

            <div class="input-wrapper">
                <div id="input-area" class="hidden">
                    <div id="attempts-bar">• • •</div>
                    <form id="game-form" autocomplete="off" onsubmit="handleFormSubmit(event)">
                        <input type="text" id="native-input" placeholder="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" enterkeyhint="go">
                        <button type="button" id="submit-btn" onclick="submitMath()">➔</button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <div id="pause-overlay" class="hidden">
        <h2 style="color:white; margin-bottom:30px; font-size: 2rem; font-weight: 800;">ПАУЗА</h2>
        <button class="main-btn" style="width: 70%; max-width: 300px;" onclick="togglePause()">ПРОДОЛЖИТЬ</button>
        <button class="main-btn" style="width: 70%; max-width: 300px; background:#333; margin-top:15px;" onclick="stopGame()">В МЕНЮ</button>
    </div>

    <div id="result-screen" class="hidden">
        <div class="menu-content" style="margin: auto;">
            <div class="settings-block">
                <h1 style="color: var(--success-color); margin-bottom: 20px;">Готово!</h1>
                <p style="margin: 8px 0; color:#aaa; font-size: 1.2rem; font-weight:700;">Уровень: <b style="color:white" id="res-level"></b></p>
                <p style="margin: 8px 0; color:#aaa; font-size: 1.2rem; font-weight:700;">Ответов: <b style="color:white" id="final-score"></b></p>
                <p style="margin: 8px 0; color:#aaa; font-size: 1.2rem; font-weight:700;">Время: <b style="color:white" id="final-time"></b></p>
            </div>
            <button class="main-btn" onclick="showSetup()">МЕНЮ</button>
        </div>
    </div>

    <script>
        const viewport = window.visualViewport;
        const appContainer = document.getElementById('app-viewport');
        function resizeHandler() {
            if (!viewport) return;
            appContainer.style.height = `${viewport.height}px`;
            window.scrollTo(0, 0);
        }
        if (viewport) {
            viewport.addEventListener('resize', resizeHandler);
            viewport.addEventListener('scroll', resizeHandler);
            resizeHandler();
        }

        // --- БАЗЫ СЛОВ ---
        const vocabNouns = `год человек время дело жизнь день рука раз работа слово место лицо друг глаз вопрос дом сторона страна мир случай голова ребенок сила конец вид система часть город отношение женщина деньги земля машина вода отец проблема право нога решение дверь образ история власть закон война бог голос тысяча книга возможность результат ночь стол имя область статья число компания народ жена группа развитие процесс условие средство свет университет действие солнце любовь слух проект час порядок путь душа помощь рынок очередь письмо армия век ход язык ряд движение огонь директор стена встреча цель школа план информация воздух интерес смерть программа задача опыт тело игра лес двор окно центр семья плечо президент врач номер суд угол учитель район небо совет золото музыка память граница знак форма собака камень боль сын мысль спорт герой дерево здание связь поэт снег сон элемент ухо вера остров банк расход материал воля сад курс река мужик рот край мост лист честь автор вечер цвет полк радость птица круг труп смысл масло дождь экран слеза зверь конкурс танец нос корень песня класс завод удар лидер этап брат стул штаб звук дед метр песок стих хлеб фильм рубль шанс тип смех море зона товар кусок служба характер возраст рыба рост сцена крыша поиск долг вождь мозг итог пиво чай губа дядя черт конь шея танк кадр слой спор вкус след толпа вход риск указ зима мода шум лето пост сбор куст обед вред шарф паук слон цирк бак бокс винт гриб зонт клоп клей лифт пуля торт флаг цепь шина юбка ящик гром холм тигр волк барс рысь краб омар скат кит морж пони овца коза лось енот крот мышь сова гусь утка аист грач стриж удав оса муха блоха клещ моль рак щука карп сом линь агат алмаз болт гипс дерн жесть игла ковш лом маяк нож плуг руль сеть трос узел шип щит якорь азот бром воск газ гель дым йод лак мел пар пух сажа соль торф уран хром цинк шлак бор вяз дуб ива кедр клен липа пальма роза алоэ мак пион ирис анис боб лук рапс рис соя тыква укроп хвощ шпинат вена веко десна жила зуб кожа кость нерв ноготь пуп ребро таз череп бинт вата жгут мазь зонд клизма очки шприц гимн джаз марш нота опера опус ритм соло туш хор балл гейм гол пас сет финт шах мат кросс старт трек ямб хорей стопа слог эпос миф ода сказ жанр стиль тема том бот бриг плот порт трап трюм шлюз ялик крах кризис налог сбыт торг цена чек штраф виза иск кодекс устав ценз штат брак внук вдова зять кум сват тесть тетя атом ватт вольт джоуль ион катод квант ом фаза фон эхо анод диод лампа луч реле ток щуп`;
        const vocabVerbs = `быть мочь сказать говорить знать стать есть хотеть видеть идти думать спросить жить смотреть сидеть иметь делать взять понять казаться давать пойти увидеть дать писать ждать найти остаться решить выйти пройти писать помнить стоять слушать верить купить уйти начать читать слышать любить отвечать смотреть работать спать звать просить играть лежать ходить помочь открыть закрыть начать терять держать найти менять забыть искать вести платить простить учить кричать бояться падать садиться встать молчать спешить пить бежать ловить бить гореть ехать лететь петь смеяться желать бросить плакать строить ломать носить тянуть дышать хватать спасти расти звать везти беречь дарить лечить учить жалеть варить жарить печь шить мыть брить лить дуть гнуть греть тереть висеть блестеть шуметь звенеть греметь стучать скрипеть пищать жужжать рычать мычать лаять мяукать кусать клевать бодать жалить колоть резать рубить пилить копать пахать сеять жать веять молоть косить грести везти нести вести ползти лезть плыть брести цвести пахнуть вянуть киснуть мокнуть сохнуть мерзнуть зябнуть стынуть слепнуть глохнуть пухнуть гаснуть липнуть виснуть тонуть гибнуть крепнуть хрипнуть сипнуть охнуть ахнуть топнуть хлопнуть свистнуть прыгнуть шагнуть кивнуть махнуть мигнуть зевать чихать кашлять икать стонать храпеть сопеть сипеть хрипеть гудеть зудеть болеть терпеть вертеть глядеть лететь свистеть хрустеть шелестеть шуршать ворчать бурчать журчать звучать молчать кричать визжать верещать трещать пищать рычать стучать бренчать бринчать звякать брякать квакать каркать чирикать куковать курлыкать мурлыкать кудахтать гоготать хохотать хихикать шептать лепетать бормотать лопотать мямлить`;
        const vocabAdj = `большой маленький новый старый хороший плохой белый черный красный синий зеленый желтый добрый злой умный глупый веселый грустный быстрый медленный легкий тяжелый мягкий твердый теплый холодный горячий свежий черствый сухой мокрый чистый грязный дорогой дешевый богатый бедный сильный слабый больной здоровый правый левый живой мертвый громкий тихий длинный короткий широкий узкий толстый тонкий высокий низкий глубокий мелкий прямой кривой острый тупой гладкий шершавый частый редкий густой жидкий вкусный горький кислый сладкий соленый пресный светлый темный яркий тусклый цветной мутный прозрачный нежный грубый верный ложный честный подлый смелый трусливый гордый скромный жадный щедрый сытый голодный полный пустой целый битый нужный лишний важный главный простой сложный трудный легкий ранний поздний юный старый молодой зрелый детский женский мужской русский чужой родной дикий ручной домашний лесной речной морской горный степной полевой луговой зимний летний весенний осенний утренний дневной вечерний ночной вчерашний сегодняшний завтрашний прошлый будущий вечный временный скорый долгий краткий частый редкий первый второй третий последний крайний средний верхний нижний ближний дальний задний передний левый правый прямой обратный встречный попутный тайный явный видный скрытый общий частный личный чужой свой единый разный всякий каждый любой иной другой прочий`;

        function parseVocab(text) {
            return text.split(/\s+/).map(w => w.trim().toLowerCase()).filter(w => w.length > 0);
        }

        const wordsNoun = parseVocab(vocabNouns);
        const wordsVerb = parseVocab(vocabVerbs);
        const wordsAdj = parseVocab(vocabAdj);
        const wordsMix = [...wordsNoun, ...wordsVerb, ...wordsAdj].sort(() => Math.random() - 0.5);

        function generateMathProblem(difficulty) {
            let a, b, op, res;
            const ops = ['+', '-', '*', '/'];
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            while (true) {
                op = ops[Math.floor(Math.random() * ops.length)];
                
                if (difficulty === 'math_table') { 
                    if (op === '+') { a = rand(2, 20); b = rand(2, 20); if(a+b > 30) continue; }
                    else if (op === '-') { a = rand(5, 30); b = rand(2, a); }
                    else if (op === '*') { a = rand(2, 9); b = rand(2, 9); }
                    else if (op === '/') { b = rand(2, 9); res = rand(2, 9); a = b * res; }
                } 
                else if (difficulty === 'math100') { 
                    if (op === '+') { a = rand(10, 80); b = rand(10, 20); }
                    else if (op === '-') { a = rand(20, 100); b = rand(5, a); }
                    else if (op === '*') { a = rand(3, 15); b = rand(2, 6); }
                    else if (op === '/') { b = rand(2, 8); res = rand(5, 12); a = b * res; }
                }
                else if (difficulty === 'math500') { 
                    if (op === '+') { a = rand(50, 400); b = rand(50, 100); }
                    else if (op === '-') { a = rand(150, 500); b = rand(50, a - 50); }
                    else if (op === '*') { a = rand(12, 40); b = rand(3, 9); }
                    else if (op === '/') { b = rand(4, 15); res = rand(15, 30); a = b * res; }
                }

                if (op === '+') res = a + b;
                if (op === '-') res = a - b;
                if (op === '*') res = a * b;
                if (op === '/') res = a / b;

                if (difficulty === 'math_table' && res > 81) continue;
                if (difficulty === 'math100' && res > 100) continue;
                if (difficulty === 'math500' && (res < 100 || res > 500)) continue;

                let visualOp = op;
                if(op === '*') visualOp = '×';
                if(op === '/') visualOp = ':';

                return {
                    question: `${a} ${visualOp} ${b}`,
                    answer: res.toString()
                };
            }
        }

        // --- СОСТОЯНИЕ ---
        let currentMode = 'noun'; 
        let activeWordList = wordsNoun;
        let isMathMode = false;

        let nLevel = 2;
        let targetInputs = 20;
        let memoTime = 3; 
        let history = []; 
        let recallIndex = 0;
        let attempts = 3;
        let isGameRunning = false;
        let isPaused = false;
        let needsInput = false;
        
        let gameTimer = null; 
        let cardTimerInterval = null;
        let totalSeconds = 0;
        let mainTimerInterval = null;

        // DOM
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultScreen = document.getElementById('result-screen');
        const wordCard = document.getElementById('word-card');
        const wordDisplay = document.getElementById('word-display');
        const wordIndexEl = document.getElementById('word-index');
        const cardTimerEl = document.getElementById('card-timer');
        const inputArea = document.getElementById('input-area');
        const nativeInput = document.getElementById('native-input');
        const attemptsBar = document.getElementById('attempts-bar');
        const waitMsg = document.getElementById('wait-msg');
        const pauseOverlay = document.getElementById('pause-overlay');
        const timerDisplay = document.getElementById('timer');
        const progressDisplay = document.getElementById('progress');
        const submitBtn = document.getElementById('submit-btn');
        const keyboardSpacer = document.getElementById('keyboard-spacer');

        // --- УПРАВЛЕНИЕ МЕНЮ (Радикальное решение) ---
        function onInputFocus(inputElement) {
            // Увеличиваем распорку внизу, чтобы было куда скроллить
            keyboardSpacer.style.height = "400px";
            // Ждем пока клавиатура выедет и скроллим
            setTimeout(() => {
                inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        
        function onInputBlur() {
            // Убираем распорку
            keyboardSpacer.style.height = "0px";
        }

        // --- ВЫБОР РЕЖИМА ---
        function setMode(mode, btn) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (mode.startsWith('math') || mode === 'super_mix') {
                isMathMode = true; 
                activeWordList = []; 
            } else {
                isMathMode = false;
                if (mode === 'noun') activeWordList = wordsNoun;
                else if (mode === 'verb') activeWordList = wordsVerb;
                else if (mode === 'adj') activeWordList = wordsAdj;
                else if (mode === 'mix') activeWordList = wordsMix;
            }
        }

        // --- ИГРА ---
        function showSetup() {
            clearTimeout(gameTimer);
            clearInterval(mainTimerInterval);
            clearInterval(cardTimerInterval);
            setupScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            pauseOverlay.classList.add('hidden');
        }

        function startGame() {
            nLevel = parseInt(document.getElementById('n-level').value);
            targetInputs = parseInt(document.getElementById('round-count').value);
            memoTime = parseInt(document.getElementById('memo-time').value);

            if (targetInputs <= nLevel) {
                targetInputs = nLevel + 1;
                document.getElementById('round-count').value = targetInputs;
            }
            if (!currentMode.startsWith('math') && currentMode !== 'super_mix' && targetInputs > activeWordList.length) {
                targetInputs = activeWordList.length;
            }

            history = [];
            recallIndex = 0;
            isGameRunning = true;
            isPaused = false;
            
            nativeInput.setAttribute('type', 'text');
            nativeInput.setAttribute('inputmode', 'text');

            totalSeconds = 0;
            timerDisplay.innerText = "00:00";
            document.getElementById('display-n').innerText = nLevel;
            updateProgress();

            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            resultScreen.classList.add('hidden');
            pauseOverlay.classList.add('hidden');
            
            clearInterval(mainTimerInterval);
            mainTimerInterval = setInterval(() => {
                if(!isPaused && isGameRunning) {
                    totalSeconds++;
                    const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const s = (totalSeconds % 60).toString().padStart(2, '0');
                    timerDisplay.innerText = `${m}:${s}`;
                }
            }, 1000);

            nextTurn();
        }

        function stopGame() {
            isGameRunning = false;
            showSetup();
        }

        function togglePause() {
            if (!isGameRunning) return;
            isPaused = !isPaused;
            if (isPaused) {
                clearTimeout(gameTimer);
                clearInterval(cardTimerInterval);
                pauseOverlay.classList.remove('hidden');
                nativeInput.blur();
            } else {
                pauseOverlay.classList.add('hidden');
                if (needsInput) {
                    nativeInput.focus();
                } else {
                    nextTurn(); 
                }
            }
        }

        function nextTurn() {
            if (!isGameRunning) return;

            if (recallIndex >= targetInputs) {
                endGame();
                return;
            }

            nativeInput.value = '';
            nativeInput.className = '';
            nativeInput.classList.remove('input-success', 'input-error'); // Сброс классов
            attempts = 3;
            updateHearts();
            clearInterval(cardTimerInterval);

            // Генерация
            let isGenerating = history.length < targetInputs;
            let displayContent = "";

            if (isGenerating) {
                let item = {};
                let genType = 'word';
                
                if (currentMode.startsWith('math')) {
                    genType = 'math';
                } else if (currentMode === 'super_mix') {
                    genType = Math.random() < 0.5 ? 'math' : 'word';
                }

                if (genType === 'math') {
                    let difficulty = currentMode === 'super_mix' ? 'math_table' : currentMode;
                    item = generateMathProblem(difficulty);
                    item.type = 'math';
                } else {
                    let list = (currentMode === 'super_mix') ? wordsNoun : activeWordList;
                    const w = list[Math.floor(Math.random() * list.length)];
                    item = { question: w, answer: w, type: 'word' };
                }

                history.push(item);
                displayContent = item.question;
                wordDisplay.classList.remove('countdown-big');
            } else {
                let remaining = targetInputs - recallIndex;
                displayContent = remaining;
                wordDisplay.classList.add('countdown-big');
            }

            wordDisplay.innerText = displayContent;
            needsInput = history.length > nLevel;

            if (needsInput) {
                // АКТИВНЫЙ ХОД
                wordCard.classList.remove('hidden');
                inputArea.classList.remove('hidden');
                waitMsg.classList.add('hidden');
                
                wordIndexEl.classList.add('hidden');
                cardTimerEl.classList.add('hidden');
                updateProgress();
                
                // Переключение клавиатуры
                const targetIndex = history.length - 1 - nLevel;
                const targetItem = history[targetIndex];
                
                if (targetItem.type === 'math') {
                    nativeInput.setAttribute('type', 'tel');
                    nativeInput.setAttribute('inputmode', 'decimal');
                    submitBtn.style.display = 'flex';
                    attemptsBar.classList.add('shifted'); // Сдвиг точек
                } else {
                    nativeInput.setAttribute('type', 'text');
                    nativeInput.setAttribute('inputmode', 'text');
                    submitBtn.style.display = 'none';
                    attemptsBar.classList.remove('shifted'); // Сдвиг обратно
                }
                
                setTimeout(() => { if(!isPaused) nativeInput.focus(); }, 50);

            } else {
                // ЗАПОМИНАНИЕ
                wordCard.classList.remove('hidden');
                inputArea.classList.add('hidden');
                waitMsg.classList.add('hidden'); 
                nativeInput.blur();
                
                progressDisplay.innerText = `${recallIndex}/${targetInputs}`;
                
                wordIndexEl.innerText = history.length;
                wordIndexEl.classList.remove('hidden');
                
                cardTimerEl.classList.remove('hidden');
                let timeLeft = memoTime;
                cardTimerEl.innerText = timeLeft;
                
                cardTimerInterval = setInterval(() => {
                    timeLeft--;
                    if(timeLeft < 1) timeLeft = 0;
                    cardTimerEl.innerText = timeLeft;
                }, 1000);
                
                gameTimer = setTimeout(() => {
                    if(!isGameRunning || isPaused) return;
                    clearInterval(cardTimerInterval);
                    nextTurn();
                }, memoTime * 1000); 
            }
        }

        function submitMath() {
            handleFormSubmit({ preventDefault: () => {} });
            nativeInput.focus();
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            if (!needsInput || isPaused) return;

            let userText = nativeInput.value.trim().toLowerCase();
            if (!userText) return;

            const targetItem = history[recallIndex];
            
            if (targetItem.type === 'math') {
                userText = userText.replace(',', '.');
            }

            const targetAnswer = targetItem.answer.toLowerCase();

            let isCorrect = false;
            const normUser = userText.replace(/ё/g, 'е');
            const normTarget = targetAnswer.replace(/ё/g, 'е');
            isCorrect = (normUser === normTarget);

            if (isCorrect) {
                nativeInput.classList.add('input-success');
                finishRound(true);
            } else {
                attempts--;
                updateHearts();
                nativeInput.classList.add('input-error');
                if (navigator.vibrate) navigator.vibrate(200);

                setTimeout(() => {
                    nativeInput.classList.remove('input-error');
                    if (attempts > 0) nativeInput.value = ''; // Очищаем только если есть попытки
                }, 500);

                if (attempts <= 0) {
                    // ПОКАЗ ОТВЕТА ПРИ ПРОИГРЫШЕ
                    setTimeout(() => {
                        nativeInput.value = targetAnswer; // Показываем ответ
                        nativeInput.classList.add('input-success'); // Красим в зеленый для наглядности
                        setTimeout(() => {
                            finishRound(false);
                        }, 1500); // Ждем 1.5 сек
                    }, 500);
                }
            }
        }
        
        function finishRound(success) {
            recallIndex++; 
            updateProgress();
            // Если успех - быстрый переход, если провал - мы уже подождали 1.5 сек
            let delay = success ? 400 : 100; 
            
            if(success) {
                 gameTimer = setTimeout(() => { nextTurn(); }, delay);
            } else if (attempts <= 0) {
                 nextTurn();
            }
        }

        function updateHearts() {
            let h = "";
            for(let i=0; i < attempts; i++) h += "• "; 
            attemptsBar.innerText = h;
        }

        function updateProgress() {
            let displayCount = recallIndex;
            if (needsInput && recallIndex < targetInputs) displayCount = recallIndex + 1;
            progressDisplay.innerText = `${displayCount}/${targetInputs}`;
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(mainTimerInterval);
            clearInterval(cardTimerInterval);
            nativeInput.blur();
            gameScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            document.getElementById('res-level').innerText = nLevel + "-Back";
            document.getElementById('final-score').innerText = recallIndex; 
            const m = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const s = (totalSeconds % 60).toString().padStart(2, '0');
            document.getElementById('final-time').innerText = `${m}:${s}`;
        }
    </script>
</body>
</html>